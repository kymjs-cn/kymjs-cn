<!doctype html> <html class="no-js" lang="en"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>对Android中的多图片异步加载的重新思考</title> <link rel="stylesheet" href="/assets/css/styles_feeling_responsive.css"> <script src="/assets/js/modernizr.min.js"></script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="description" content="现在想来，Android SDK把并行执行改为串行执行也并不无道理。"/> <link rel="author" href="https://plus.google.com/u/0/110645272912875945931"/> <link rel="icon" sizes="32x32" href="/assets/img/favicon-32x32.png"> <link rel="icon" sizes="192x192" href="/assets/img/touch-icon-192x192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/assets/img/apple-touch-icon-180x180-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/img/apple-touch-icon-76x76-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-precomposed.png"> <meta name="msapplication-TileImage" content="/assets/img/msapplication_tileimage.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="en_EN" /> <meta property="og:type" content="website" /> <meta property="og:title" content="对Android中的多图片异步加载的重新思考" /> <meta property="og:description" content="无论何时，请保持学者的谦逊与宽容。"/> <meta property="og:url" content="//AsyncTask/" /> <meta property="og:site_name" content="kymjs张涛" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="//humans.txt" /> </head> <body id="top-of-page" class="page-fullwidth"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="" class="icon-tree"> kymjs张涛</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="right"> <li class="divider"></li> <li><a href="/donate">捐赠</a></li> <li class="divider"></li> <li><a href="/about">这是我</a></li> </ul> <ul class="left"> <li class="has-dropdown"> <a href="/code">代码与技术</a> <ul class="dropdown"> <li><a href="/code/android">Android</a></li> <li><a href="/code/ios">IOS</a></li> <li><a href="/code/algorithm">算法</a></li> </ul> </li> <li class="divider"></li> <li><a href="/product">产品体验分析</a></li> <li class="divider"></li> <li><a href="/read">阅读与感悟</a></li> <li class="divider"></li> <li><a href="/manager">开发团队管理</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="/osl">开源实验室</a> <ul class="dropdown"> <li><a href="/osl/framework">Android框架解读</a></li> <li><a href="/osl/ui">UI控件</a></li> <li><a href="/osl/app">开源APP</a></li> </ul> </li> <li class="divider"></li> </ul> </section> </nav> </div><!-- /#navigation --> <div class="row t30"> <div class="medium-12 columns"> <article> <header> <p class="subheadline">代码与技术</p> <h1>对Android中的多图片异步加载的重新思考</h1> </header> <p class="teaser"> 现在想来，Android SDK把并行执行改为串行执行也并不无道理。 </p> <p> 不知道大家有没有发现，在2.0.4.1(37)版本之前的开源中国客户端首次加载图片的时候，会很慢，尤其是动弹列表中的图片。甚至网速慢的时候感觉图片根本加载不出来。 </p> <p> 原因是在下载网络图片的时候使用了多线程并发执行的方式，什么意思呢，也就是开启了多个线程同时去下载多张图片。按照正常的思维来想，做图片加载操作使用多线程，这应该是很正常的，因为在我们的思维中，多线程资源利用率更高，程序响应更快。 </p> <p> 举个例子：一个应用程序需要从本地文件系统中读取和处理文件的情景。比方说，从磁盘读取一个文件需要5秒，处理一个文件需要2秒。处理两个文件则需要 </p><pre class="brush:java;toolbar: true; auto-links: false;">5秒读取文件A
2秒处理文件A
5秒读取文件B
2秒处理文件B
---------------------
总共需要14秒</pre><p> 从磁盘中读取文件的时候，大部分的CPU时间用于等待磁盘去读取数据。在这段时间里，CPU非常的空闲。它可以做一些别的事情。通过改变操作的顺序，就能够更好的使用CPU资源。看下面的顺序<br /> </p><pre class="brush:java;toolbar: true; auto-links: false;">5秒读取文件A
5秒读取文件B + 2秒处理文件A
2秒处理文件B
---------------------
总共需要12秒</pre><p> CPU等待第一个文件被读取完。然后开始读取第二个文件。当第二文件在被读取的时候，CPU会去处理第一个文件。记住，在等待磁盘读取文件的时候，CPU大部分时间是空闲的。总的说来，CPU能够在等待IO的时候做一些其他的事情。这个不一定就是磁盘IO。它也可以是网络的IO，或者用户输入。通常情况下，网络和磁盘的IO比CPU和内存的IO慢的多。 </p> <p> 既然采用多线程并发执行可以提高CPU的利用率，可是为什么反倒用在Android的图片加载上变得更慢了？<br /> </p> <p> 看到这里，你应该已经想到原因了。就好像我们写代码，一个人同时写两个Android应用，并发布上线。假设应用发布不需要上线审核，且A与B的功能几乎相同。如果我们去先写应用A的一个功能，当A某一个功能写完的时候再去写应用B相同的功能，那么写起来自然是要快很多。这就是并发执行，同时去执行A与B。但是这样A与B完成的总时间是缩短了，可以单个A应用完成的时间却被拉长了。因为写到一半的时候被迫去完成B应用。 </p> <p> 所以这也是为什么你会发现37版本之前的OSC客户端图片几乎是同时出来的。 </p> <hr /> <p> 回到Android上，我之前的博客曾讲过<span style="color: rgb(51, 51, 51); font-family: Verdana, sans-serif, 宋体; letter-spacing: 0.5px; line-height: 22.5px; background-color: rgb(255, 255, 255);">：AsyncTask在android2.3的时候线程池是一个核心数为5线程，队列可容纳10线程，最大执行128个任务，这存在一个问题，当你真的有138个并发时，即使手机没被你撑爆，那么超出这个指标应用绝对crash掉。 后来升级到3.0，为了避免并发带来的一些列问题，AsyncTask竟然成为序列执行器了，也就是你即使你同时execute N个AsyncTask，它也是挨个排队执行的。 这一点请同学们一定注意，AsyncTask在3.0以后，是异步的没错，但不是并发的</span><span style="color: rgb(51, 51, 51); font-family: Verdana, sans-serif, 宋体; letter-spacing: 0.5px; line-height: 22.5px; background-color: rgb(255, 255, 255);">。不知道的同学可以去看看<span style="line-height: 22.5px; color: rgb(51, 51, 51); font-family: Verdana, sans-serif, 宋体; letter-spacing: 0.5px; background-color: rgb(255, 255, 255);">《</span><a href="http://my.oschina.net/kymjs/blog/313744" target="_blank" rel="nofollow">Thread并发请求封装——深入理解AsyncTask类</a><span style="line-height: 22.5px; color: rgb(51, 51, 51); font-family: Verdana, sans-serif, 宋体; letter-spacing: 0.5px; background-color: rgb(255, 255, 255);">》</span>《<a href="http://my.oschina.net/kymjs/blog/350565" target="_self" rel="nofollow">一套完善的Android异步任务类</a>》</span> </p> <p> <span style="color: rgb(51, 51, 51); font-family: Verdana, sans-serif, 宋体; letter-spacing: 0.5px; line-height: 22.5px; background-color: rgb(255, 255, 255);">现在想来，Android SDK把并行执行改为串行执行也并不无道理。</span> </p> <p> 也许你会担心，那改回串行以后会不会又出现同时加载129个图片的时候崩溃的问题。当然，是不会的。在图片加载的时候已经做了下载任务取消的设计，在listView中加载图片的时候，如果滚动出这一屏，图片的下载任务会马上停止，而去加载新的图片下载。总不会一个屏幕就显示129张图吧。 </p><pre class="brush:java;toolbar: true; auto-links: false;">/**
* 取消一个下载请求
*
* @param view
*/
public void cancle(View view) {
for (BitmapWorkerTask task : taskCollection) {
if (task.imageView.equals(view)) {
task.cancelTask();
taskCollection.remove(task);
break;
}
}
}</pre><p> <br /> </p> </article> </div><!-- /.medium-12.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="footer"> <div class="row"> <div class="medium-6 large-5 columns"> <h5 class="shadow-black">公众号：Android技术分享</h5> <p class="shadow-black"> <img src="/images/qrcode.jpg" alt="无论何时，请保持学者的谦逊与宽容。" width="120" height="120"/> </p> </div><!-- /.large-6.columns --> <div class="small-6 medium-3 large-3 large-offset-1 columns"> <h5 class="shadow-black">推荐站点</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="services-contact" > <a href="/android_design" title="Android应用设计指南">Android应用设计指南</a> </li> <li class="services-contact" > <a href="/kjframe" title="KJFrame框架 API">KJFrameForAndroid API</a> </li> </ul> </div><!-- /.large-4.columns --> <div class="small-6 medium-3 large-3 columns"> <h5 class="shadow-black">推荐博客</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="network-entypo" > <a href="http://www.xiequan.info/" target="_blank" title="谢权">Android达人-谢权</a> </li> <li class="services-newsletter" > <a href="http://www.vmatianyu.cn/" target="_blank" title="马天宇博客">bong智能：马天宇</a> </li> <li class="rss-link" > <a href="http://www.aplesson.com/" target="_blank" title="Android+PHP=APlesson">开源爱好者：谭东</a> </li> <li class="sitemap-link" > <a href="http://blog.csdn.net/bboyfeiyu" target="_blank" title="Mr.Simple">Mr.Simple博客</a> </li> </ul> </div><!-- /.large-3.columns --> </div><!-- /.row --> </div><!-- /#footer --> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>站务联系 QQ:766136833 </li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://twitter.com/kymjs123" target="_blank" class="icon-twitter" title="Twitter"></a></li> <li><a href="http://github.com/kymjs" target="_blank" class="icon-github" title="Code"></a></li> <li><a href="http://www.kymjs.com/" target="_blank" class="icon-xing" title="张涛"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="/assets/js/javascript.min.js"></script> </body> </html>
