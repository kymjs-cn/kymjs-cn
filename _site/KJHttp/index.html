<!doctype html> <html class="no-js" lang="en"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>迄今最好的Http请求框架使用讲解</title> <link rel="stylesheet" href="/assets/css/styles_feeling_responsive.css"> <script src="/assets/js/modernizr.min.js"></script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="description" content="写给那些在用、想用、还没有用过KJFrame的朋友。 KJFrameForAndroid总共分为四个功能：Activity继承链的规范，Http数据请求和上传下载，Bitmap大图加载以及ListView滚动时只加载内存图片，数据库对象存储与集合对象存储。还有一个独立出来的功能CJFrame插件化开发框架，支持启动在你的手机中未安装的apk应用。 "/> <link rel="author" href="https://plus.google.com/u/0/110645272912875945931"/> <link rel="icon" sizes="32x32" href="/assets/img/favicon-32x32.png"> <link rel="icon" sizes="192x192" href="/assets/img/touch-icon-192x192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/assets/img/apple-touch-icon-180x180-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/img/apple-touch-icon-76x76-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-precomposed.png"> <meta name="msapplication-TileImage" content="/assets/img/msapplication_tileimage.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="en_EN" /> <meta property="og:type" content="website" /> <meta property="og:title" content="迄今最好的Http请求框架使用讲解" /> <meta property="og:description" content="无论何时，请保持学者的谦逊与宽容。"/> <meta property="og:url" content="//KJHttp/" /> <meta property="og:site_name" content="kymjs张涛" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="//humans.txt" /> </head> <body id="top-of-page" class="page-fullwidth"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="" class="icon-tree"> kymjs张涛</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="right"> <li class="divider"></li> <li><a href="/donate">捐赠</a></li> <li class="divider"></li> <li><a href="/about">这是我</a></li> </ul> <ul class="left"> <li class="has-dropdown"> <a href="/code">代码与技术</a> <ul class="dropdown"> <li><a href="/code/android">Android</a></li> <li><a href="/code/ios">IOS</a></li> <li><a href="/code/algorithm">算法</a></li> </ul> </li> <li class="divider"></li> <li><a href="/product">产品体验分析</a></li> <li class="divider"></li> <li><a href="/read">阅读与感悟</a></li> <li class="divider"></li> <li><a href="/manager">开发团队管理</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="/osl">开源实验室</a> <ul class="dropdown"> <li><a href="/osl/framework">Android框架解读</a></li> <li><a href="/osl/ui">UI控件</a></li> <li><a href="/osl/app">开源APP</a></li> </ul> </li> <li class="divider"></li> </ul> </section> </nav> </div><!-- /#navigation --> <div class="row t30"> <div class="medium-12 columns"> <article> <header> <p class="subheadline">代码与技术</p> <h1>迄今最好的Http请求框架使用讲解</h1> </header> <p class="teaser"> 写给那些在用、想用、还没有用过KJFrame的朋友。 KJFrameForAndroid总共分为四个功能：Activity继承链的规范，Http数据请求和上传下载，Bitmap大图加载以及ListView滚动时只加载内存图片，数据库对象存储与集合对象存储。还有一个独立出来的功能CJFrame插件化开发框架，支持启动在你的手机中未安装的apk应用。 </p> <p>KJFrameForAndroid下载地址：<a href="https://github.com/kymjs/KJFrameForAndroid">https://github.com/kymjs/KJFrameForAndroid</a></p> <h2 id="section">基础功能</h2> <p>KJHttp是专为解决Android中Http通信而产生的，它在请求和响应层面做到了全自动构建和解析，主要用于Android快速开发。<br /> KJHttp自带了数据缓存功能，你所访问的Http数据都将在本地建立一个缓存，默认的缓存时间是5分钟，也就是5分钟以内相同的请求都不会经过网络，而是从本地缓存中直接读取。当然对于及时性要求较高的新闻类应用，你也可以关闭这个特性或者只需要将缓存时间设置成0就行了~<br /> KJHttp支持JSON格式参数提交、AJAX方式的Form表单参数提交，文件与图片的上传下载，同时支持根据你的需求所发起的自定义Request。</p> <h2 id="section-1">工作原理</h2> <p>整个KJHttp工作流程：采用责任链设计模式，由三部分组成，类似设计可以类比Handle…Looper…MessageQueue<br /> 1. KJHttp负责不停向NetworkQueue(或CacheQueue实际还是NetworkQueue， 具体逻辑请查看 {@link CacheDispatcher})添加Request<br /> 2. 另一边由TaskThread不停从NetworkQueue中取Request并交给Network执行器(逻辑请查看 {@link NetworkDispatcher} )，<br /> 3. Network执行器将执行成功的NetworkResponse返回给TaskThead，并通过Request的定制方法 {@link Request#parseNetworkResponse()}封装成Response，最终交给分发器 {@link Delivery} 分发到主线程并调用HttpCallback相应的方法</p> <h2 id="section-2">基础用法</h2> <h3 id="getpostjson">get或post以JSON传参的方式请求数据示例</h3> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm">   * 使用JSON提交参数而不是Form表单</span>
<span class="cm">   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">jsonRequest</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">KJHttp</span> <span class="n">kjh</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">KJHttp</span><span class="o">();</span>
      <span class="n">HttpParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HttpParams</span><span class="o">();</span>
      <span class="n">params</span><span class="o">.</span><span class="na">putHeaders</span><span class="o">(</span><span class="s">&quot;Cookie&quot;</span><span class="o">,</span> <span class="s">&quot;cookie不能告诉你&quot;</span><span class="o">);</span>

      <span class="c1">//这里传递json字符串，(JSONObject可以调用toString方法转换)</span>
      <span class="n">params</span><span class="o">.</span><span class="na">putJsonParams</span><span class="o">(</span><span class="n">jsonObj</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="n">kjh</span><span class="o">.</span><span class="na">jsonPost</span><span class="o">(</span>
              <span class="s">&quot;http://www.oschina.net/action/api/team_stickynote_batch_update&quot;</span><span class="o">,</span>
              <span class="n">params</span><span class="o">,</span> <span class="k">new</span> <span class="nf">HttpCallBack</span><span class="o">()</span> <span class="o">{</span>
                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                      <span class="kd">super</span><span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                      <span class="n">toast</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">});</span>
  <span class="o">}</span></code></pre></div> <h3 id="getpostajaxjson">get或post以AJAX方式请求JSON数据示例</h3> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">KJHttp</span> <span class="n">kjh</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">KJHttp</span><span class="o">();</span>
  <span class="n">HttpParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HttpParams</span><span class="o">();</span> 
  <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;1&quot;</span><span class="o">);</span> <span class="c1">//传递参数</span>
  <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;kymjs&quot;</span><span class="o">);</span>
  <span class="c1">//HttpCallback中有很多方法，可以根据需求选择实现</span>
  <span class="n">kjh</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">&quot;http://192.168.1.149/post_api&quot;</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="k">new</span> <span class="nf">HttpCallBack</span><span class="o">()</span> <span class="o">{</span>

      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
          <span class="n">ViewInject</span><span class="o">.</span><span class="na">longToast</span><span class="o">(</span><span class="s">&quot;请求成功&quot;</span><span class="o">);</span>
          <span class="n">KJLoger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;log:&quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="c1">// ......</span>
      <span class="c1">//还有更多，就不一一介绍了，大家可以参考API文档</span>
      <span class="c1">// ......</span>
  <span class="o">});</span></code></pre></div> <h3 id="filebyte">文件上传支持多文件上传，支持传file对象，byte[]两种</h3> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">upload</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">HttpParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HttpParams</span><span class="o">();</span>
      <span class="c1">//可多次put，支持多文件上传</span>
      <span class="n">params</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;file&quot;</span><span class="o">,</span> <span class="n">FileUtils</span><span class="o">.</span><span class="na">getSaveFile</span><span class="o">(</span><span class="s">&quot;KJLibrary&quot;</span><span class="o">,</span> <span class="s">&quot;logo.jpg&quot;</span><span class="o">));</span>
      <span class="n">kjh</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">&quot;http://192.168.1.149/kymjs/hello.php&quot;</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span>
              <span class="k">new</span> <span class="nf">HttpCallBack</span><span class="o">()</span> <span class="o">{</span>
                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">String</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                      <span class="kd">super</span><span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
                      <span class="n">ViewInject</span><span class="o">.</span><span class="na">toast</span><span class="o">(</span><span class="s">&quot;success&quot;</span><span class="o">);</span>
                  <span class="o">}</span>

                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">errorNo</span><span class="o">,</span>
                          <span class="n">String</span> <span class="n">strMsg</span><span class="o">)</span> <span class="o">{</span>
                      <span class="kd">super</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">errorNo</span><span class="o">,</span> <span class="n">strMsg</span><span class="o">);</span>
                      <span class="n">ViewInject</span><span class="o">.</span><span class="na">toast</span><span class="o">(</span><span class="s">&quot;error&quot;</span> <span class="o">+</span> <span class="n">strMsg</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="cm">/** 还有更多实现... **/</span>
              <span class="o">});</span>
  <span class="o">}</span></code></pre></div> <h3 id="section-3">文件下载与断点续传</h3> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">kjh</span><span class="o">.</span><span class="na">download</span><span class="o">(</span><span class="s">&quot;http://www.kymjs.com/app/kjblog.apk&quot;</span><span class="o">,</span> <span class="s">&quot;file.apk&quot;</span><span class="o">,</span><span class="k">new</span> <span class="nf">HttpCallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">File</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onSuccess</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
            <span class="n">KJLoger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;success&quot;</span><span class="o">);</span>
            <span class="n">ViewInject</span><span class="o">.</span><span class="na">toast</span><span class="o">(</span><span class="s">&quot;toast&quot;</span><span class="o">);</span>
            <span class="n">mProgress</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="n">mProgress</span><span class="o">.</span><span class="na">getMax</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">errorNo</span><span class="o">,</span><span class="n">String</span> <span class="n">strMsg</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">errorNo</span><span class="o">,</span> <span class="n">strMsg</span><span class="o">);</span>
            <span class="n">KJLoger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;onFailure&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/* onLoading 方法就只在文件下载时才会被回调 */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onLoading</span><span class="o">(</span><span class="kt">long</span> <span class="n">count</span><span class="o">,</span> <span class="kt">long</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onLoading</span><span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">current</span><span class="o">);</span>
            <span class="n">mProgress</span><span class="o">.</span><span class="na">setMax</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">count</span><span class="o">);</span>
            <span class="n">mProgress</span><span class="o">.</span><span class="na">setProgress</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">current</span><span class="o">);</span>
            <span class="n">KJLoger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">count</span> <span class="o">+</span> <span class="s">&quot;------&quot;</span> <span class="o">+</span> <span class="n">current</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span></code></pre></div> <h2 id="section-4">更多可配置方法</h2> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">KJHttp</span> <span class="n">kjh</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">KJHttp</span><span class="o">();</span>
<span class="c1">//取消一个请求</span>
<span class="n">kjh</span><span class="o">.</span><span class="na">cancle</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>

<span class="c1">//读取一个本地缓存数据</span>
<span class="n">kjh</span><span class="o">.</span><span class="na">getCache</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>

<span class="c1">//删除一个本地缓存</span>
<span class="n">kjh</span><span class="o">.</span><span class="na">removeCache</span><span class="o">(</span><span class="n">url</span><span class="o">);</span></code></pre></div> <h2 id="section-5">高级设置</h2> <p>以上是基础用法，同样也支持自定义设置，你可以自定义数据缓存的方式，请求的优先级，请求数据的有效时间。同时支持根据你的需求所发起的自定义Request。 更多的使用，可以参考实际项目中的使用<a href="https://github.com/KJFrame/KJBlog">爱看博客客户端</a></p> </article> </div><!-- /.medium-12.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="footer"> <div class="row"> <div class="medium-6 large-5 columns"> <h5 class="shadow-black">公众号：Android技术分享</h5> <p class="shadow-black"> <img src="/images/qrcode.jpg" alt="无论何时，请保持学者的谦逊与宽容。" width="120" height="120"/> </p> </div><!-- /.large-6.columns --> <div class="small-6 medium-3 large-3 large-offset-1 columns"> <h5 class="shadow-black">推荐站点</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="services-contact" > <a href="/android_design" title="Android应用设计指南">Android应用设计指南</a> </li> <li class="services-contact" > <a href="/kjframe" title="KJFrame框架 API">KJFrameForAndroid API</a> </li> </ul> </div><!-- /.large-4.columns --> <div class="small-6 medium-3 large-3 columns"> <h5 class="shadow-black">推荐博客</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="network-entypo" > <a href="http://www.xiequan.info/" target="_blank" title="谢权">Android达人-谢权</a> </li> <li class="services-newsletter" > <a href="http://www.vmatianyu.cn/" target="_blank" title="马天宇博客">bong智能：马天宇</a> </li> <li class="rss-link" > <a href="http://www.aplesson.com/" target="_blank" title="Android+PHP=APlesson">开源爱好者：谭东</a> </li> <li class="sitemap-link" > <a href="http://blog.csdn.net/bboyfeiyu" target="_blank" title="Mr.Simple">Mr.Simple博客</a> </li> </ul> </div><!-- /.large-3.columns --> </div><!-- /.row --> </div><!-- /#footer --> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>站务联系 QQ:766136833 </li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://twitter.com/kymjs123" target="_blank" class="icon-twitter" title="Twitter"></a></li> <li><a href="http://github.com/kymjs" target="_blank" class="icon-github" title="Code"></a></li> <li><a href="http://www.kymjs.com/" target="_blank" class="icon-xing" title="张涛"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="/assets/js/javascript.min.js"></script> </body> </html>
