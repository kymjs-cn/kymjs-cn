<!doctype html> <html class="no-js" lang="en"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>深入讲解WebView——下</title> <link rel="stylesheet" href="/assets/css/styles_feeling_responsive.css"> <script src="/assets/js/modernizr.min.js"></script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="description" content="作为Android开发者，我们都知道在手机中内置了一款高性能 webkit 内核浏览器,在 SDK 中封装为一个叫做 WebView 组件。今天就为大家讲讲Android中WebView的详细使用方法"/> <link rel="author" href="https://plus.google.com/u/0/110645272912875945931"/> <link rel="icon" sizes="32x32" href="/assets/img/favicon-32x32.png"> <link rel="icon" sizes="192x192" href="/assets/img/touch-icon-192x192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/assets/img/apple-touch-icon-180x180-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/img/apple-touch-icon-76x76-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-precomposed.png"> <meta name="msapplication-TileImage" content="/assets/img/msapplication_tileimage.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="en_EN" /> <meta property="og:type" content="website" /> <meta property="og:title" content="深入讲解WebView——下" /> <meta property="og:description" content="无论何时，请保持学者的谦逊与宽容。"/> <meta property="og:url" content="//WebView2/" /> <meta property="og:site_name" content="kymjs张涛" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="//humans.txt" /> </head> <body id="top-of-page" class="page-fullwidth"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="" class="icon-tree"> kymjs张涛</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="right"> <li class="divider"></li> <li><a href="/donate">捐赠</a></li> <li class="divider"></li> <li><a href="/about">这是我</a></li> </ul> <ul class="left"> <li class="has-dropdown"> <a href="/code">代码与技术</a> <ul class="dropdown"> <li><a href="/code/android">Android</a></li> <li><a href="/code/ios">IOS</a></li> <li><a href="/code/algorithm">算法</a></li> </ul> </li> <li class="divider"></li> <li><a href="/product">产品体验分析</a></li> <li class="divider"></li> <li><a href="/read">阅读与感悟</a></li> <li class="divider"></li> <li><a href="/manager">开发团队管理</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="/osl">开源实验室</a> <ul class="dropdown"> <li><a href="/osl/framework">Android框架解读</a></li> <li><a href="/osl/ui">UI控件</a></li> <li><a href="/osl/app">开源APP</a></li> </ul> </li> <li class="divider"></li> </ul> </section> </nav> </div><!-- /#navigation --> <div class="row t30"> <div class="medium-12 columns"> <article> <header> <p class="subheadline">代码与技术</p> <h1>深入讲解WebView——下</h1> </header> <p class="teaser"> 作为Android开发者，我们都知道在手机中内置了一款高性能 webkit 内核浏览器,在 SDK 中封装为一个叫做 WebView 组件。今天就为大家讲讲Android中WebView的详细使用方法 </p> <p>接上一篇博客【<a href="http://blog.kymjs.com/code/2015/05/03/01/">深入讲解WebView上</a>】</p> <h2 id="webview-">判断 WebView 是否已经滚动到页面底端</h2> <p>在View中有一个getScrollY()方法，可以返回当前可见区域的顶端距整个页面顶端的距离,也就是当前内容滚动的距离。<br /> 还有getHeight()或者 getBottom()方法都返回当前 View 这个容器的高度<br /> 在ViewView中还有getContentHeight() 方法可以返回整个 html 页面的高度,但并不等同于当前整个页面的高度 ,因为 WebView 有缩放功能。你可以通过如下代码来启动或关闭webview的缩放功能。<br /></p> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">mWebView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">().</span><span class="na">setSupportZoom</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">mWebView</span><span class="o">.</span><span class="na">getSettings</span><span class="o">().</span><span class="na">setBuiltInZoomControls</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span></code></pre></div> <p>所以当前整个页面的高度实际上应该是原始 html 的高度再乘上缩放比例. 因此,更正后的结果 ,准确的判断方法应该是:<br /></p> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 如果已经处于底端</span>
<span class="k">if</span><span class="o">(</span><span class="n">WebView</span><span class="o">.</span><span class="na">getContentHeight</span><span class="o">*</span><span class="n">WebView</span><span class="o">.</span><span class="na">getScale</span><span class="o">()</span> <span class="o">-(</span><span class="n">webvi</span> <span class="n">ew</span><span class="o">.</span><span class="na">getHeight</span><span class="o">()+</span><span class="n">WebView</span><span class="o">.</span><span class="na">getScrollY</span><span class="o">())){</span> 
  <span class="c1">//XXX</span>
<span class="o">}</span></code></pre></div> <h2 id="webview-session-">WebView获取服务器中的 session 问题</h2> <p>接下来我们讲如下两个问题：<br /> 1、Android 中的 WebView 如何获取服务器页面的 jsessionid 的值<br /> 2、Android 的 WebView 又是如何把得到的 jsessionid 的值在 set 到服务器中,一致达到他们在同一个 jsessionid 的回话中.<br /> 其实非常非常简单，只不过是几个方法罢了:<br /></p> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">CookieManager</span> <span class="n">cm</span> <span class="o">=</span> <span class="n">CookieManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span> 
<span class="n">cm</span><span class="o">.</span><span class="na">removeAllCookie</span><span class="o">();</span>
<span class="n">cm</span><span class="o">.</span><span class="na">getCookie</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
<span class="n">cm</span><span class="o">.</span><span class="na">setCookie</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">cookie</span><span class="o">);</span></code></pre></div> <p>另外还有个 CookieSyncManager,也许你会在一些旧的项目中看到它。从名字来理解，它实际上应该是一个异步缓存器。不过我们看到这个方法已经被标记为过时了，查看源码可以看到过时原因是现在WebView已经是自动的异步缓存了，所以这个类已经没有存在的意义了。 <a href="http://blog.kymjs.com/"><img src="http://blog.kymjs.com/images/blog_image/20150504_1.png" alt="CookieSyncManager" /></a></p> <h2 id="webviewcookies">WebView清除本地cookies</h2> <p>在使用网页版淘宝或百度登录时,WebView会自动登录上次的帐号!(因为WebView 记录了帐号和密码的cookies) 所以,需要清除 SessionCookie也是有必要的。<br /> 那么CookieManager同样也为我们提供了清除cookie的方法 <br /> CookieManager.getInstance().removeSessionCookie();<br /></p> <p>这里顺便说一下WebView本身也是会记录html缓存的，上一篇博客中我讲了一种通过文件操作去清理缓存的方法，后来我又发现，其实webview本身就提供了清理缓存的方法，其中参数true是指是否包括磁盘文件也一并清除，传true就和我们昨天的讲的效果是一样的了：<br /></p> <div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">webview</span><span class="o">.</span><span class="na">clearCache</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">webview</span><span class="o">.</span><span class="na">clearHistory</span><span class="o">();</span></code></pre></div> <h2 id="section">讲一个案例</h2> <p>讲了这么多的理论知识，最后讲一个使用案例。WebView在实际使用中可以分为两种使用方法，第一种就是类似于QQ微信那种，使用loadUrl直接去显示一个链接，这种方式太简单了，传一个url就行，我就不多说了。<br /> 那么需要详细讲的是第二种，类似的实现大家可以看看开源中国客户端，网易新闻客户端，爱看博客，等客户端的实现方式，它们实际上也是通过webview来显示的一个网页内容，但是并不是单纯的loadurl,而是以字符串的形式去加载一个已经获取到了的html源代码。这样做的好处在于显示的页面可以完全的根据自己喜好来定义，比如我想在末尾添加一张图片，那么简单，在这个html字符串的末尾插入一个img标签就可了。至于使用方法，其实我们在上一篇博客的时候有提到过：</p> <p>myWebView.loadData(htmlText,”text/html”, “utf-8”);</p> <p>其中htmltext就是我们需要加载的html字符串，使用这个方法可以直接将这个字符串作为网页来显示。<br /> 最后总结一下两种方法的适用场景，前一种载入链接的方法适合一个界面(Activity或Fragment)只有一个WebView或者说WebView占很大一块的时候，同时我们要显示的内容是未知的，那么自然是使用loadurl方法更合适，例如QQ聊天的时候对方发送一条链接，当QQ解析出这个文本是一个网址时就通过webview去加载它。而后一种则适合于定制化内容，一般是那种你可以明确的制度网页内容以及要显示的内容时使用，至于好处就是上面说的，定制性要好很多。<br /></p> <h2 id="section-1">相关解答</h2> <p>关于上一篇博客，有朋友问我如何实现web调用手机摄像头。很遗憾我不是做web的，对这块不是很懂。不过我建议你看一下开源中国的html5手机版的发布动弹那里，点击选择文件以后，会自动弹出相机选项，不知道可以可行。<a href="http://m.oschina.net/my/new-tweet">http://m.oschina.net/my/new-tweet</a><br /> <a href="http://blog.kymjs.com/"><img src="http://blog.kymjs.com/images/blog_image/20150504_2.png" alt="osc" /></a><br /></p> </article> </div><!-- /.medium-12.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="footer"> <div class="row"> <div class="medium-6 large-5 columns"> <h5 class="shadow-black">公众号：Android技术分享</h5> <p class="shadow-black"> <img src="/images/qrcode.jpg" alt="无论何时，请保持学者的谦逊与宽容。" width="120" height="120"/> </p> </div><!-- /.large-6.columns --> <div class="small-6 medium-3 large-3 large-offset-1 columns"> <h5 class="shadow-black">推荐站点</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="services-contact" > <a href="/android_design" title="Android应用设计指南">Android应用设计指南</a> </li> <li class="services-contact" > <a href="/kjframe" title="KJFrame框架 API">KJFrameForAndroid API</a> </li> </ul> </div><!-- /.large-4.columns --> <div class="small-6 medium-3 large-3 columns"> <h5 class="shadow-black">推荐博客</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="network-entypo" > <a href="http://www.xiequan.info/" target="_blank" title="谢权">Android达人-谢权</a> </li> <li class="services-newsletter" > <a href="http://www.vmatianyu.cn/" target="_blank" title="马天宇博客">bong智能：马天宇</a> </li> <li class="rss-link" > <a href="http://www.aplesson.com/" target="_blank" title="Android+PHP=APlesson">开源爱好者：谭东</a> </li> <li class="sitemap-link" > <a href="http://blog.csdn.net/bboyfeiyu" target="_blank" title="Mr.Simple">Mr.Simple博客</a> </li> </ul> </div><!-- /.large-3.columns --> </div><!-- /.row --> </div><!-- /#footer --> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>站务联系 QQ:766136833 </li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://twitter.com/kymjs123" target="_blank" class="icon-twitter" title="Twitter"></a></li> <li><a href="http://github.com/kymjs" target="_blank" class="icon-github" title="Code"></a></li> <li><a href="http://www.kymjs.com/" target="_blank" class="icon-xing" title="张涛"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="/assets/js/javascript.min.js"></script> </body> </html>
