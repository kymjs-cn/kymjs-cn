<!doctype html> <html class="no-js" lang="en"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>仿iPhone辅助球实现</title> <link rel="stylesheet" href="/assets/css/styles_feeling_responsive.css"> <script src="/assets/js/modernizr.min.js"></script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="description" content="过年在家时，翻出来了很多去年写的代码。就挑出来了一些自我感觉良好的讲解了。"/> <link rel="author" href="https://plus.google.com/u/0/110645272912875945931"/> <link rel="icon" sizes="32x32" href="/assets/img/favicon-32x32.png"> <link rel="icon" sizes="192x192" href="/assets/img/touch-icon-192x192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/assets/img/apple-touch-icon-180x180-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/img/apple-touch-icon-76x76-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-precomposed.png"> <meta name="msapplication-TileImage" content="/assets/img/msapplication_tileimage.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="en_EN" /> <meta property="og:type" content="website" /> <meta property="og:title" content="仿iPhone辅助球实现" /> <meta property="og:description" content="无论何时，请保持学者的谦逊与宽容。"/> <meta property="og:url" content="//iPhoneBall/" /> <meta property="og:site_name" content="kymjs张涛" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="//humans.txt" /> </head> <body id="top-of-page" class="page-fullwidth"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="" class="icon-tree"> kymjs张涛</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="right"> <li class="divider"></li> <li><a href="/donate">捐赠</a></li> <li class="divider"></li> <li><a href="/about">这是我</a></li> </ul> <ul class="left"> <li class="has-dropdown"> <a href="/code">代码与技术</a> <ul class="dropdown"> <li><a href="/code/android">Android</a></li> <li><a href="/code/ios">IOS</a></li> <li><a href="/code/algorithm">算法</a></li> </ul> </li> <li class="divider"></li> <li><a href="/product">产品体验分析</a></li> <li class="divider"></li> <li><a href="/read">阅读与感悟</a></li> <li class="divider"></li> <li><a href="/manager">开发团队管理</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="/osl">开源实验室</a> <ul class="dropdown"> <li><a href="/osl/framework">Android框架解读</a></li> <li><a href="/osl/ui">UI控件</a></li> <li><a href="/osl/app">开源APP</a></li> </ul> </li> <li class="divider"></li> </ul> </section> </nav> </div><!-- /#navigation --> <div class="row t30"> <div class="medium-12 columns"> <article> <header> <p class="subheadline">代码与技术</p> <h1>仿iPhone辅助球实现</h1> </header> <p class="teaser"> 过年在家时，翻出来了很多去年写的代码。就挑出来了一些自我感觉良好的讲解了。 </p> <p><a href="http://blog.kymjs.com"><img src="/images/blog_image/20150412_1.jpg" alt="示例图片：" /></a></p> <p>效果如图，demo中我并没有做完全和iphone那样展开的菜单(因为懒)。<br /> 那么接下来就讲讲这个能漂浮在任意Activity、包括手机桌面上的手势菜单是如何实现的。<br /></p> <p>首先从宏观原理上来讲，它就是一个跑在Service中的View。<br /> 从细节上来讲，主要有两个问题需要我们注意：<br /> &gt; 如何让一个Service中能够显示出View来。<br /> &gt; 如何让这个View做到相应手势事件(包括点击和拖动)<br /></p> <p>第一个问题：这要从Activity开始讲起了。<br /> 我们都知道，Android中的View并不包括Activity、ActionBar、Dialog、Notification等。Activity能够显示出一个View，是因为我们调用了setContentView()这个方法。再往深层看，Activity之所以能显示View是因为Activity本身使用has…a…关系包含了一个Window对象，而这个Window对象可以理解为一个屏幕，如果你有做过IOS开发，你一定能理解这个Window的含义，其实就是代表了当前屏幕。<br /> 通过这个Window对象，我们可以获得一个DecorView对象，这个DecorView对象是一个ViewGroup就是当前屏幕的根View，一切Activity的ContentView都会被add进这个DecorView容器中。<br /></p> <p>再回到上一个问题，View是如何显示出来的。<br /> 在Window对象中，有一个内部类叫做LocalWindowManager，这个内部类实现了一个接口叫WindowManager，而就是这个LocalWindowManager在实现WindowManager.addView()接口方法的时候，实现了在屏幕上绘制View的功能。<br /></p> <p>原理说了这么多，你也许已经糊涂了，这到底和Service显示View有什么关系。<br /> 其实很简单，因为Window对象负责显示我们的View，那么在Service中得到当前的Window对象，一切问题就解决了。<br /> 在Context中有一个获取当前系统管理者的方法叫getSystemService(String name);我们就通过这个方法来获取到Window对象中的WindowManager而这里得到的WindowManager对象就是上文提到的LocalWindowManager对象。通过给这个对象的addView()再添加一个我们的手势球View，就解决了View显示问题。<br /></p> <p>第二个问题：让一个View随着手指移动而移动。<br /> 有两种方法实现这种需求。<br /> 在《疯狂Android讲义》中有一章是介绍通过自定义控件的形式，重写ondraw()方法来实现，这是在View内部封装，这里我不讲了，希望了解的可以自己去看看电子书。我实现的方法是通过外部给View设置触摸事件监听setOnTouchListener()，然后通过当前手指所在屏幕的坐标，来动态修改View的margin边距来达到View改变位置的效果。<br /></p> <p>具体实现，我们来这个核心Service类<br /></p><pre><code>public class TopFloatService extends Service implements OnClickListener {
    WindowManager wm = null;
    WindowManager.LayoutParams ballWmParams = null;
    private float mTouchStartX;
    private float mTouchStartY;
    private float x;
    private float y;
    private View ballView; // 球状态View
    private View menuView; // 菜单状态View
    private PopupWindow pop;
    private Button floatImage;
    private RelativeLayout menuLayout; // 菜单的布局
    private RelativeLayout menuTop;
    private boolean ismoving = false;

    @Override
    public void onCreate() {
        super.onCreate();
        // 加载辅助球布局
        ballView = View.inflate(this, R.layout.floatball, null);
        floatImage = (Button) ballView.findViewById(R.id.float_image);
        setUpFloatMenuView();
        createView();
    }

    /**
     * 窗口菜单初始化
     */
    private void setUpFloatMenuView() {
        menuView = View.inflate(this, R.layout.floatmenu, null);
        menuLayout = (RelativeLayout) menuView.findViewById(R.id.menu);
        menuTop = (RelativeLayout) menuView.findViewById(R.id.lay_main);
        menuLayout.setOnClickListener(this);
        menuTop.setOnClickListener(this);
    }

    @Override
    public void onClick(View v) {
        switch (v.getId()) {
        case R.id.lay_main:
            Toast.makeText(getApplicationContext(), "111", Toast.LENGTH_SHORT)
                    .show();
            break;

        default:
            if (pop != null &amp;&amp; pop.isShowing()) {
                pop.dismiss();
            }
            break;
        }
    }

    private void createView() {
        wm = (WindowManager) getSystemService("window");
        ballWmParams = new WindowManager.LayoutParams();
        ballWmParams.type = WindowManager.LayoutParams.TYPE_PHONE;
        ballWmParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
        ballWmParams.gravity = Gravity.LEFT | Gravity.TOP;
        ballWmParams.x = 0;
        ballWmParams.y = 0;
        ballWmParams.width = WindowManager.LayoutParams.WRAP_CONTENT;
        ballWmParams.height = WindowManager.LayoutParams.WRAP_CONTENT;
        ballWmParams.format = PixelFormat.RGBA_8888;
        // 添加显示
        wm.addView(ballView, ballWmParams);
        // 注册触摸事件监听
        floatImage.setOnTouchListener(new OnTouchListener() {
            public boolean onTouch(View v, MotionEvent event) {
                x = event.getRawX();
                y = event.getRawY();
                switch (event.getAction()) {
                case MotionEvent.ACTION_DOWN:
                    ismoving = false;
                    mTouchStartX = (int) event.getX();
                    mTouchStartY = (int) event.getY();
                    break;
                case MotionEvent.ACTION_MOVE:
                    ismoving = true;
                    updateViewPosition();
                    break;
                case MotionEvent.ACTION_UP:
                    mTouchStartX = mTouchStartY = 0;
                    break;
                }
                // 如果拖动则返回false，否则返回true
                if (ismoving == false) {
                    return false;
                } else {
                    return true;
                }
            }

        });
        // 注册点击事件监听
        floatImage.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                // 获取在xml中定义的大小
                DisplayMetrics dm = getResources().getDisplayMetrics();
                pop = new PopupWindow(menuView, dm.widthPixels, dm.heightPixels);
                pop.showAtLocation(ballView, Gravity.CENTER, 0, 0);
                pop.update();
            }
        });
    }

    /**
     * 更新view的显示位置
     */
    private void updateViewPosition() {
        ballWmParams.x = (int) (x - mTouchStartX);
        ballWmParams.y = (int) (y - mTouchStartY);
        wm.updateViewLayout(ballView, ballWmParams);
    }

    @Override
    public IBinder onBind(Intent intent) {
        return null;
    }
}
</code></pre></article> </div><!-- /.medium-12.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="footer"> <div class="row"> <div class="medium-6 large-5 columns"> <h5 class="shadow-black">公众号：Android技术分享</h5> <p class="shadow-black"> <img src="/images/qrcode.jpg" alt="无论何时，请保持学者的谦逊与宽容。" width="120" height="120"/> </p> </div><!-- /.large-6.columns --> <div class="small-6 medium-3 large-3 large-offset-1 columns"> <h5 class="shadow-black">推荐站点</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="services-contact" > <a href="/android_design" title="Android应用设计指南">Android应用设计指南</a> </li> <li class="services-contact" > <a href="/kjframe" title="KJFrame框架 API">KJFrameForAndroid API</a> </li> </ul> </div><!-- /.large-4.columns --> <div class="small-6 medium-3 large-3 columns"> <h5 class="shadow-black">推荐博客</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="network-entypo" > <a href="http://www.xiequan.info/" target="_blank" title="谢权">Android达人-谢权</a> </li> <li class="services-newsletter" > <a href="http://www.vmatianyu.cn/" target="_blank" title="马天宇博客">bong智能：马天宇</a> </li> <li class="rss-link" > <a href="http://www.aplesson.com/" target="_blank" title="Android+PHP=APlesson">开源爱好者：谭东</a> </li> <li class="sitemap-link" > <a href="http://blog.csdn.net/bboyfeiyu" target="_blank" title="Mr.Simple">Mr.Simple博客</a> </li> </ul> </div><!-- /.large-3.columns --> </div><!-- /.row --> </div><!-- /#footer --> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>站务联系 QQ:766136833 </li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://twitter.com/kymjs123" target="_blank" class="icon-twitter" title="Twitter"></a></li> <li><a href="http://github.com/kymjs" target="_blank" class="icon-github" title="Code"></a></li> <li><a href="http://www.kymjs.com/" target="_blank" class="icon-xing" title="张涛"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="/assets/js/javascript.min.js"></script> </body> </html>
