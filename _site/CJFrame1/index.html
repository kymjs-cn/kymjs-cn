<!doctype html> <html class="no-js" lang="en"> <head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <title>Android插件化开发，初入殿堂</title> <link rel="stylesheet" href="/assets/css/styles_feeling_responsive.css"> <script src="/assets/js/modernizr.min.js"></script> <noscript> <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov' rel='stylesheet' type='text/css'> </noscript> <meta name="description" content="好久没有写博客了，这次准备写写我这几天的研究成果——Android插件化开发框架CJFrameForAndroid。"/> <link rel="author" href="https://plus.google.com/u/0/110645272912875945931"/> <link rel="icon" sizes="32x32" href="/assets/img/favicon-32x32.png"> <link rel="icon" sizes="192x192" href="/assets/img/touch-icon-192x192.png"> <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/assets/img/apple-touch-icon-180x180-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/assets/img/apple-touch-icon-76x76-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="/assets/img/apple-touch-icon-precomposed.png"> <meta name="msapplication-TileImage" content="/assets/img/msapplication_tileimage.png"/> <meta name="msapplication-TileColor" content="#fabb00"> <!-- Facebook Optimization --> <meta property="og:locale" content="en_EN" /> <meta property="og:type" content="website" /> <meta property="og:title" content="Android插件化开发，初入殿堂" /> <meta property="og:description" content="无论何时，请保持学者的谦逊与宽容。"/> <meta property="og:url" content="//CJFrame1/" /> <meta property="og:site_name" content="kymjs张涛" /> <!-- Search Engine Optimization --> <link type="text/plain" rel="author" href="//humans.txt" /> </head> <body id="top-of-page" class="page-fullwidth"> <div id="navigation" class="sticky"> <nav class="top-bar" data-topbar> <ul class="title-area"> <li class="name"> <h1 class="show-for-small-only"><a href="" class="icon-tree"> kymjs张涛</a></h1> </li> <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone --> <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li> </ul> <section class="top-bar-section"> <ul class="right"> <li class="divider"></li> <li><a href="/donate">捐赠</a></li> <li class="divider"></li> <li><a href="/about">这是我</a></li> </ul> <ul class="left"> <li class="has-dropdown"> <a href="/code">代码与技术</a> <ul class="dropdown"> <li><a href="/code/android">Android</a></li> <li><a href="/code/ios">IOS</a></li> <li><a href="/code/algorithm">算法</a></li> </ul> </li> <li class="divider"></li> <li><a href="/product">产品体验分析</a></li> <li class="divider"></li> <li><a href="/read">阅读与感悟</a></li> <li class="divider"></li> <li><a href="/manager">开发团队管理</a></li> <li class="divider"></li> <li class="has-dropdown"> <a href="/osl">开源实验室</a> <ul class="dropdown"> <li><a href="/osl/framework">Android框架解读</a></li> <li><a href="/osl/ui">UI控件</a></li> <li><a href="/osl/app">开源APP</a></li> </ul> </li> <li class="divider"></li> </ul> </section> </nav> </div><!-- /#navigation --> <div class="row t30"> <div class="medium-12 columns"> <article> <header> <p class="subheadline">代码与技术</p> <h1>Android插件化开发，初入殿堂</h1> </header> <p class="teaser"> 好久没有写博客了，这次准备写写我这几天的研究成果——Android插件化开发框架CJFrameForAndroid。 </p> <p> 好久没有写博客了，这次准备写写我这几天的研究成果——Android插件化开发框架<a target="_blank" href="https://github.com/kymjs/CJFrameForAndroid" rel="nofollow">CJFrameForAndroid。</a> </p> <h3> <strong>背景交代</strong><br /> </h3> <p> &nbsp;&nbsp;&nbsp;&nbsp;首先，你需要知道什么是插件化开发。就拿最常见的QQ来说，在第三个界面动态那里有个管理，点开后可以选择很多的增植功能，这里腾讯只放了一些网页应用，那么如果未来想加入一个打飞机游戏，要怎么做？让用户重新安装吗，这就是插件化开发所解决的问题。 </p> <p> &nbsp;&nbsp;&nbsp;&nbsp;用一句话来概括插件式开发：你基本上可以理解为让一个apk不安装也可以被运行。只不过这个运行是有很多限制的运行，所以才叫插件否则就叫病毒了。其实在目前淘宝、百度、腾讯、等都有成熟的动态加载框架，包括apkplug，但是它们都是不开源的。 </p> <p> &nbsp;&nbsp;&nbsp; 说一下我认为这项技术的难点：<span style="color:#E53333;">1、一个未被安装的apk正常情况无法被运行；2、这个apk的资源没办法被引用；3、这个apk的界面就算被加载，也没办法与用户交互。</span> </p> <p> &nbsp;&nbsp;&nbsp;&nbsp;最初查遍了资料，第一点好解决，在Android中有一个dexClassLoad类加载器，大家应该明白了，就是通过反射加载一个类来运行。第二点，网上有两种方法：可以将插件的资源放到sd卡上通过流的形式读取，不过也有人反对说用流读取会有问题，通配性太差；一种比较好的解决办法是将apk中的资源复制一份到当前app内，然后就可以加载了。这种办法是不错，但是用户每下载一次插件就复制一份，久而久之，对空间要求太高了，还有就是第三点也没办法解决。而第三点，在github上有一个叫<a target="_self" href="https://github.com/mmin18/AndroidDynamicLoader" rel="nofollow">AndroidDynamicLoader</a>的项目，是通过用Fragment做为插件的表现形式，由于Fragment特殊性（既可以处理逻辑交互又具备与Activity相同的生命周期）。可是Fragment限制性太大了，太过碎片化使得使用起来复杂性过高。直到我找到了一篇360的官方博客，博客给了一种思路：<span style="color:#009900;">通过代理/委托模式设计的Application类去动态的改变一个apk所在的环境，实现动态加载的目的</span>。抱着这种思路，我曾想自己去设计一个application类，但是技术有限，太复杂了，于是结合AndroidDynamicLoader的思路与360的思路，我自己设计了一个Activity去代理插件的Activity，于是就有了CJFrameForAndroid. </p> <h3> 原理描述 </h3> <p> 首先解释几个名词： </p> <p> <strong>APP项目</strong>：指要调用插件apk的那个已经安装到用户手机上的应用。<br /><strong>插件项目</strong>：指没有被安装且希望借助已经安装到手机上的项目运行的apk。<br /><strong>插件化</strong>：Activity继承自CJActivity，且与APP项目jar包冲突已经解决的插件项目称为已经被插件化。<br /><strong>Activity事务</strong>：在CJFrameForAndroid中，一个Activity的生命周期以及交互事件统称为Activity的事务。<br /><strong>托管所</strong>：指插件中的一个委派/代理Activity，通过这个Activity去处理插件中Activity的全部事务，从而表现为就像插件中的Activity在运行一样。 </p> <p> CJFrameForAndroid的实现原理是通过类加载器，动态加载存在于SD卡上的apk包中的Activity。通过使用一个托管所，插件Activity全部事务(包括声明周期与交互事件)将交由托管所来处理，间接实现插件的运行。<br />一句话描述：CJFrameForAndroid中的托管所，复制了插件中的Activity，来替代插件中的Activity与用户交互。<br />看到这里你应该就明白了，整个框架最核心的部分就是这个托管所。这里给出CJFrameForAndroid中这个托管所的细节代码： </p><pre class="brush:java;toolbar: true; auto-links: false;">    /**
* 通过反射，获取到插件的资源访问器
*/
protected void initResources() {
try {
AssetManager assetManager = AssetManager.class.newInstance();
Method addAssetPath = assetManager.getClass().getMethod(
&quot;addAssetPath&quot;, String.class);
addAssetPath.invoke(assetManager, mDexPath);
mAssetManager = assetManager;
} catch (Exception e) {
e.printStackTrace();
}
Resources superRes = super.getResources();
mResources = new Resources(mAssetManager, superRes.getDisplayMetrics(),
superRes.getConfiguration());
mTheme = mResources.newTheme();
mTheme.setTo(super.getTheme());
}

/**
* 启动插件的Activity
*/
protected void launchPluginActivity() {
PackageInfo packageInfo = CJTool.getAppInfo(this, mDexPath);
if ((packageInfo.activities != null)
&amp;&amp; (packageInfo.activities.length &gt; 0)) {
String activityName = packageInfo.activities[mAtyIndex].name;
mClass = activityName;
launchPluginActivity(mClass);
}
}

/**
* 启动指定的Activity
* 
* @param className
*            要启动的Activity完整类名
*/
protected void launchPluginActivity(final String className) {
try {
Class&lt;?&gt; atyClass = getClassLoader().loadClass(className);
Constructor&lt;?&gt; atyConstructor = atyClass
.getConstructor(new Class[] {});
Object instance = atyConstructor.newInstance(new Object[] {});
setRemoteActivity(instance);
mPluginAty.setProxy(this, mDexPath);
Bundle bundle = new Bundle();
bundle.putInt(CJConfig.FROM, CJConfig.FROM_PROXY_APP);
mPluginAty.onCreate(bundle);
} catch (Exception e) {
e.printStackTrace();
}
}

/**
* 保留一份插件Activity对象
*/
protected void setRemoteActivity(Object activity) {
if (activity instanceof I_CJActivity) {
mPluginAty = (I_CJActivity) activity;
} else {
throw new ClassCastException(
&quot;plugin activity must implements I_CJActivity&quot;);
}
}</pre><p></p> <p> 本框架目前仅仅是一个开发阶段，仅仅是实现了插件Activity的运行（原理上来说，动态注册的广播也可以运行），而Service、contentProvider都没办法使用，这些都仍在研究中。<br />在未来的某一天，也许会将这个<a target="_self" href="https://github.com/kymjs/CJFrameForAndroid" rel="nofollow">CJFrameForAndroid</a>插件框架与<a target="_self" href="https://github.com/kymjs/KJFrameForAndroid" rel="nofollow">KJFrameForAndroid</a>快捷开发框架合并，组成一个更完善应用开发框架，对自己说：加油！ </p> <p> ●目前仅支持Activity和Fragment，其他特殊组件暂未测试。<br />●APP项目和插件项目中，都需要使用到CJFrameForAndroid的jar包。<br />●在项目中必须加入托管所声明。<br />●在开发插件的时候，必须继承CJActivity;<br />●在插件的Activity中，一切使用this的部分必须使用that来替代;<br />●在插件Activity跳转时，推荐使用CJActivityUtils类来辅助跳转；<br />●在插件和APP两个工程中不能引用相同的jar包； </p> </article> </div><!-- /.medium-12.columns --> </div><!-- /.row --> <div id="up-to-top" class="row"> <div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a> </div><!-- /.small-12.columns --> </div><!-- /.row --> <footer id="footer-content" class="bg-grau"> <div id="footer"> <div class="row"> <div class="medium-6 large-5 columns"> <h5 class="shadow-black">公众号：Android技术分享</h5> <p class="shadow-black"> <img src="/images/qrcode.jpg" alt="无论何时，请保持学者的谦逊与宽容。" width="120" height="120"/> </p> </div><!-- /.large-6.columns --> <div class="small-6 medium-3 large-3 large-offset-1 columns"> <h5 class="shadow-black">推荐站点</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="services-contact" > <a href="/android_design" title="Android应用设计指南">Android应用设计指南</a> </li> <li class="services-contact" > <a href="/kjframe" title="KJFrame框架 API">KJFrameForAndroid API</a> </li> </ul> </div><!-- /.large-4.columns --> <div class="small-6 medium-3 large-3 columns"> <h5 class="shadow-black">推荐博客</h5> <ul class="no-bullet shadow-black"> <li > <a href="" title=""></a> </li> <li class="network-entypo" > <a href="http://www.xiequan.info/" target="_blank" title="谢权">Android达人-谢权</a> </li> <li class="services-newsletter" > <a href="http://www.vmatianyu.cn/" target="_blank" title="马天宇博客">bong智能：马天宇</a> </li> <li class="rss-link" > <a href="http://www.aplesson.com/" target="_blank" title="Android+PHP=APlesson">开源爱好者：谭东</a> </li> <li class="sitemap-link" > <a href="http://blog.csdn.net/bboyfeiyu" target="_blank" title="Mr.Simple">Mr.Simple博客</a> </li> </ul> </div><!-- /.large-3.columns --> </div><!-- /.row --> </div><!-- /#footer --> <div id="subfooter"> <nav class="row"> <section id="subfooter-left" class="b30 small-12 medium-6 columns"> <ul class="inline-list"> <li>站务联系 QQ:766136833 </li> </ul> </section> <section id="subfooter-right" class="small-12 medium-6 columns social-icons"> <ul class="inline-list"> <li><a href="http://twitter.com/kymjs123" target="_blank" class="icon-twitter" title="Twitter"></a></li> <li><a href="http://github.com/kymjs" target="_blank" class="icon-github" title="Code"></a></li> <li><a href="http://www.kymjs.com/" target="_blank" class="icon-xing" title="张涛"></a></li> </ul> </section> </nav> </div><!-- /#subfooter --> </footer> <script src="/assets/js/javascript.min.js"></script> </body> </html>
